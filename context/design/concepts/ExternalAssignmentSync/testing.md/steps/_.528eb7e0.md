---
timestamp: 'Thu Oct 23 2025 21:29:22 GMT-0400 (Eastern Daylight Time)'
parent: '[[../20251023_212922.e917934d.md]]'
content_id: 528eb7e0e84e2ffa475ab49b7a1bbd89a870766ea454ca9c635cade889bbeecb
---

# ExternalAssignmentSync

(Previously known as ExternalTaskSource, see the corresponding context folder for earlier edits to this spec.)

**concept** ExternalAssignmentSync \[User, Assignment]

**purpose** Enable users to seamlessly integrate and manage assignments from external platforms within the application, ensuring consistency and preventing redundant data through tracking and selective updates.

**principle** If a user connects an external assignment source with their credentials, then the system will establish and remember this connection. Subsequently, when the user requests an update, the system will fetch assignments from that source, identify only new or modified assignments based on previous syncs, and provide their details for the application to process (create or update), ensuring the application's assignment list remains current without creating duplicates. If the user later revokes access or removes the connection, all associated external assignments will be delinked from their internal counterparts.

**state**

// Defines the specific structure for connection details, e.g., for Canvas
// For other sources (e.g., GitHub Classroom), this would be extended or a union type
type ConnectionDetails = {
apiToken: String, // e.g., Canvas API token
baseUrl: URLString  // e.g., "https://canvas.instructure.com"
}

// Defines the structure of assignment data from external platforms
type ExternalAssignmentDetails = {
name: String,           // Assignment name/title
description: String?,   // Assignment description (may be null)
dueDate: Timestamp?,    // Due date (may be null for ungraded assignments)
}

// Represents active connections to external platforms, associated with a user
a set of ExternalSourceAccounts with
owner: User               // The user who owns this connection
sourceType: String        // e.g., "Canvas", "GitHub Classroom"
sourceName: String        // User-friendly label for this connection, e.g., "6.104 Canvas"
connectionDetails: ConnectionDetails // Specific credentials and endpoint info
lastSuccessfulPoll: Timestamp // Timestamp of the last successful data fetch from this external source

// Maps external assignments to their internal counterparts and tracks their state
a set of ExternalAssignments with
source: ExternalSourceAccount                     // The source this external assignment belongs to
externalId: String                                // External assignment ID from the platform (e.g., Canvas assignment ID)
internalAssignment: Assignment                    // The corresponding internal assignment identifier (generic param)
lastExternalModificationTimestamp: Timestamp      // The timestamp of the assignment's last modification on the external platform, as of the last successful sync

**actions**

connectSource (owner: User, sourceType: String, sourceName: String, details: ConnectionDetails): (sourceAccount: ExternalSourceAccount)
**purpose** Establishes a new connection to an external platform for a given user using provided credentials and identification.
**requires**
No `ExternalSourceAccount` already exists for the `owner` with the same `sourceName`.
The `details` are valid and allow successful authentication with the external platform API.
**effects**
A new unique `ExternalSourceAccount` identifier is generated and returned.
The new `ExternalSourceAccount` is added to the concept's state, storing its `owner`, `sourceType`, `sourceName`, and `connectionDetails`.
`lastSuccessfulPoll` for the new `sourceAccount` is initialized to `null`.

connectSource (owner: User, sourceType: String, sourceName: String, details: ConnectionDetails): (error: InvalidCredentialsError)
**purpose** Reports failure if the provided connection details are invalid.
**requires** The provided `details` do NOT allow successful authentication with the external platform.
**effects** Returns an `InvalidCredentialsError`.

connectSource (owner: User, sourceType: String, sourceName: String, details: ConnectionDetails): (error: NetworkError)
**purpose** Reports failure if there's a network issue preventing connection to the external platform.
**requires** A network error occurs while attempting to validate `details`.
**effects** Returns a `NetworkError`.

connectSource (owner: User, sourceType: String, sourceName: String, details: ConnectionDetails): (error: DuplicateSourceError)
**purpose** Reports failure if a source with the same name already exists for the user.
**requires** An `ExternalSourceAccount` already exists for the `owner` with the same `sourceName`.
**effects** Returns a `DuplicateSourceError`.

disconnectSource (sourceAccount: ExternalSourceAccount)
**purpose** Removes an existing connection to an external platform and all its associated assignment mappings.
**requires** `sourceAccount` exists in the concept's state.
**effects**
The `sourceAccount` and its associated data (`owner`, `sourceType`, `sourceName`, `connectionDetails`, `lastSuccessfulPoll`) are removed from the concept's state.
All mappings from `ExternalAssignmentId` to `Assignment` that are associated with the `sourceAccount` are removed.

disconnectSource (sourceAccount: ExternalSourceAccount): (error: SourceNotFound)
**purpose** Reports failure if the specified source account does not exist.
**requires** `sourceAccount` does NOT exist in the concept's state.
**effects** Returns a `SourceNotFound` error.

pollExternalSource (sourceAccount: ExternalSourceAccount): (rawExternalAssignments: set of { externalId: String, details: ExternalAssignmentDetails, externalModificationTimestamp: Timestamp })
**purpose** Calls the external API to retrieve the current list of assignments from a connected platform.
**requires**
`sourceAccount` exists in the concept's state.
`sourceAccount.connectionDetails` are valid and functional for accessing the external platform.
**effects**
Connects to the external platform using `sourceAccount.connectionDetails`.
Retrieves the current list of assignments from the external platform, including their unique identifiers (`externalId`), their full details (`details`), and their latest modification timestamps (`externalModificationTimestamp`).
`sourceAccount.lastSuccessfulPoll` is updated to the current time.
Returns the raw list of assignments.

pollExternalSource (sourceAccount: ExternalSourceAccount): (error: NetworkError)
**purpose** Reports failure due to network issues during polling.
**requires** `sourceAccount` exists and a network error occurs during the external API call.
**effects** Returns a `NetworkError`.

pollExternalSource (sourceAccount: ExternalSourceAccount): (error: ApiRateLimitError)
**purpose** Reports failure due to external API rate limits.
**requires** `sourceAccount` exists and the external API returns a rate limit error.
**effects** Returns an `ApiRateLimitError`.

pollExternalSource (sourceAccount: ExternalSourceAccount): (error: SourceConnectionError)
**purpose** Reports failure if the source account's credentials are no longer valid or the connection details are otherwise dysfunctional.
**requires** `sourceAccount` exists and the external API call fails due to invalid credentials or similar connection issues.
**effects** Returns a `SourceConnectionError`.

identifyChanges (sourceAccount: ExternalSourceAccount, rawExternalAssignments: set of { externalId: String, details: ExternalAssignmentDetails, externalModificationTimestamp: Timestamp }): (assignmentsToProcess: set of { externalId: String, details: ExternalAssignmentDetails, externalModificationTimestamp: Timestamp, existingInternalId: Assignment | null })
**purpose** Compares newly fetched external assignments against previously recorded state to identify new or updated items.
**requires** `sourceAccount` exists in the concept's state.
**effects**
For each external assignment in `rawExternalAssignments`:
If no ExternalAssignment exists with `source = sourceAccount` and `externalId = externalId`, OR if an ExternalAssignment exists but its `externalModificationTimestamp` is older than the one from `rawExternalAssignments`:
The assignment details are added to the `assignmentsToProcess` result.
`existingInternalId` is set to the `internalAssignment` from the matching ExternalAssignment if it exists, otherwise `null`.
Returns the set of assignments identified for processing.

recordInternalSync (sourceAccount: ExternalSourceAccount, externalId: String, internalId: Assignment, externalModificationTimestamp: Timestamp)
**purpose** Records that an external assignment has been successfully processed by the application (either created or updated) and mapped to an internal assignment, along with its latest external modification timestamp.
**requires** `sourceAccount` exists in the concept's state.
**effects**
If an ExternalAssignment exists with `source = sourceAccount` and `externalId = externalId`:
Updates its `internalAssignment` to `internalId` and `lastExternalModificationTimestamp` to `externalModificationTimestamp`.
Otherwise:
Creates a new ExternalAssignment with `source = sourceAccount`, `externalId = externalId`, `internalAssignment = internalId`, and `lastExternalModificationTimestamp = externalModificationTimestamp`.

**queries**

\_getSourcesForUser (user: User): (sources: array of ExternalSourceAccount)
**purpose** Retrieves all external source accounts connected by a specific user.
**requires** `user` exists in the system (implicitly, as a generic parameter).
**effects** Returns an array of all `ExternalSourceAccount` entities where `owner` is `user`.

\_getMappedInternalId (externalId: String, sourceAccount: ExternalSourceAccount): (internalId: Assignment)
**purpose** Retrieves the internal assignment ID corresponding to a given external assignment ID and source.
**requires** An ExternalAssignment exists with `source = sourceAccount` and `externalId = externalId`.
**effects** Returns the `internalAssignment` from the matching ExternalAssignment.

\_getAssignmentsForSource (sourceAccount: ExternalSourceAccount): (assignments: array of ExternalAssignment)
**purpose** Retrieves all external assignments currently synced for a specific external source account.
**requires** `sourceAccount` exists in the concept's state.
**effects** Returns an array of all ExternalAssignments where `source = sourceAccount`.

**query errors**

\_getMappedInternalId (externalId: String, sourceAccount: ExternalSourceAccount): (error: String)
**purpose** Reports failure if the external assignment is not mapped.
**requires** No ExternalAssignment exists with `source = sourceAccount` and `externalId = externalId`.
**effects** Returns error message "External assignment with ID '...' not found for source '...'".

\_getAssignmentsForSource (sourceAccount: ExternalSourceAccount): (error: String)
**purpose** Reports failure if the source account does not exist.
**requires** `sourceAccount` does NOT exist in the concept's state.
**effects** Returns error message "Source account not found".
